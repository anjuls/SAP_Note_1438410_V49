SELECT NULL BEGIN_TIME, NULL PARAMETER_NAME, NULL VALUE, NULL IS_DEFAULT,
  NULL VALUE_BEFORE, NULL WAS_DEFAULT FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL BEGIN_TIME, NULL PARAMETER_NAME, NULL VALUE, NULL IS_DEFAULT,
  NULL VALUE_BEFORE, NULL WAS_DEFAULT FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT /*+ MATERIALIZE */
    DECODE(DBID, -1, OWN_DBID, DBID) DBID,
    DECODE(INSTANCE_NUMBER, -1, USERENV('INSTANCE'), INSTANCE_NUMBER) INSTANCE_NUMBER,
    PARAMETER_NAME
  FROM
  ( SELECT
      -1 DBID,
      -1 INSTANCE_NUMBER,
      '%' PARAMETER_NAME
    FROM 
      DUAL
  ),
  ( SELECT DBID OWN_DBID FROM V$DATABASE )
)
SELECT
  DECODE(R.ID, 1, TO_CHAR(BEGIN_TIME, 'YYYY-MM-DD HH24:MI:SS'), ' ') BEGIN_TIME,
  DECODE(R.ID, 1, PARAMETER_NAME, ' ') PARAMETER_NAME,
  SUBSTR(VALUE, 1 + 59 * (R.ID - 1), 59) VALUE,
  DECODE(R.ID, 1, IS_DEFAULT, ' ') IS_DEFAULT,
  SUBSTR(VALUE_BEFORE, 1 + 59 * (R.ID - 1), 59) VALUE_BEFORE,
  DECODE(R.ID, 1, WAS_DEFAULT, ' ') WAS_DEFAULT
FROM
( SELECT ROWNUM ID FROM V$SESSTAT WHERE ROWNUM <= 20 ) R,
( SELECT
    HSS.BEGIN_INTERVAL_TIME BEGIN_TIME,
    HP2.PARAMETER_NAME PARAMETER_NAME,
    HP2.VALUE VALUE,
    NVL(HP2.ISDEFAULT, 'UNKNOWN') IS_DEFAULT,
    HP1.VALUE VALUE_BEFORE,
    NVL(HP1.ISDEFAULT, 'UNKNOWN') WAS_DEFAULT
  FROM
    BASIS_INFO BI,
    DBA_HIST_PARAMETER HP1, 
    DBA_HIST_PARAMETER HP2, 
    DBA_HIST_SNAPSHOT HSS
  WHERE
    BI.DBID = HP1.DBID AND
    BI.DBID = HP2.DBID AND
    BI.DBID = HSS.DBID AND
    BI.INSTANCE_NUMBER = HP1.INSTANCE_NUMBER AND
    BI.INSTANCE_NUMBER = HP2.INSTANCE_NUMBER AND
    BI.INSTANCE_NUMBER = HSS.INSTANCE_NUMBER AND
    HP1.PARAMETER_NAME LIKE BI.PARAMETER_NAME AND
    HP2.PARAMETER_NAME = HP1.PARAMETER_NAME AND
    HP2.SNAP_ID = HSS.SNAP_ID AND
    HP1.SNAP_ID = HP2.SNAP_ID - 1 AND
    HP1.PARAMETER_NAME = HP2.PARAMETER_NAME AND 
    HP2.VALUE != HP1.VALUE
  UNION 
  ( SELECT
      HSS.BEGIN_INTERVAL_TIME BEGIN_TIME,
      HP2.PARAMETER_NAME,
      HP2.VALUE,
      NVL(HP2.ISDEFAULT, 'UNKNOWN') IS_DEFAULT,
      NULL VALUE_BEFORE,
      'TRUE' WAS_DEFAULT
    FROM
      BASIS_INFO BI,
      DBA_HIST_PARAMETER HP2,
      DBA_HIST_SNAPSHOT HSS
    WHERE
      BI.DBID = HP2.DBID AND
      BI.DBID = HSS.DBID AND
      BI.INSTANCE_NUMBER = HP2.INSTANCE_NUMBER AND
      BI.INSTANCE_NUMBER = HSS.INSTANCE_NUMBER AND
      HP2.PARAMETER_NAME LIKE BI.PARAMETER_NAME AND
      HP2.SNAP_ID = HSS.SNAP_ID AND
      EXISTS
      ( SELECT
          * 
        FROM 
          BASIS_INFO BI,
          DBA_HIST_PARAMETER HP1 
        WHERE
          BI.DBID = HP1.DBID AND
          BI.INSTANCE_NUMBER = HP1.INSTANCE_NUMBER AND
          HP1.PARAMETER_NAME LIKE BI.PARAMETER_NAME AND
          HP1.SNAP_ID = HP2.SNAP_ID - 1 AND
          HP1.PARAMETER_NAME = 'sessions'
      ) AND
      NOT EXISTS
      ( SELECT 
          * 
        FROM 
          BASIS_INFO BI,
          DBA_HIST_PARAMETER HP1 
        WHERE
          BI.DBID = HP1.DBID AND
          BI.INSTANCE_NUMBER = HP1.INSTANCE_NUMBER AND
          HP1.PARAMETER_NAME LIKE BI.PARAMETER_NAME AND
          HP1.SNAP_ID = HP2.SNAP_ID - 1 AND
          HP1.PARAMETER_NAME = HP2.PARAMETER_NAME
      )
  )
  UNION 
  ( SELECT
      HSS.BEGIN_INTERVAL_TIME BEGIN_TIME,
      HP1.PARAMETER_NAME,
      NULL VALUE,
      'TRUE' IS_DEFAULT,
      HP1.VALUE VALUE_BEFORE,
      NVL(HP1.ISDEFAULT, 'UNKNOWN') WAS_DEFAULT
    FROM
      BASIS_INFO BI,
      DBA_HIST_PARAMETER HP1,
      DBA_HIST_SNAPSHOT HSS
    WHERE
      BI.DBID = HP1.DBID AND
      BI.DBID = HSS.DBID AND
      BI.INSTANCE_NUMBER = HP1.INSTANCE_NUMBER AND
      BI.INSTANCE_NUMBER = HSS.INSTANCE_NUMBER AND
      HP1.PARAMETER_NAME LIKE BI.PARAMETER_NAME AND
      HP1.SNAP_ID = HSS.SNAP_ID AND
      EXISTS
      ( SELECT
          * 
        FROM 
          BASIS_INFO BI,
          DBA_HIST_PARAMETER HP2 
        WHERE
          BI.DBID = HP2.DBID AND
          BI.INSTANCE_NUMBER = HP2.INSTANCE_NUMBER AND
          HP2.PARAMETER_NAME LIKE BI.PARAMETER_NAME AND
          HP1.SNAP_ID = HP2.SNAP_ID - 1 AND
          HP2.PARAMETER_NAME = 'sessions'
      ) AND
      NOT EXISTS
      ( SELECT 
          * 
        FROM 
          BASIS_INFO BI,
          DBA_HIST_PARAMETER HP2
        WHERE
          BI.DBID = HP2.DBID AND
          BI.INSTANCE_NUMBER = HP2.INSTANCE_NUMBER AND
          HP2.PARAMETER_NAME LIKE BI.PARAMETER_NAME AND
          HP1.SNAP_ID = HP2.SNAP_ID - 1 AND
          HP1.PARAMETER_NAME = HP2.PARAMETER_NAME
      )
  )  
) P
WHERE
  R.ID <= TRUNC(LENGTH(P.VALUE) - 1) / 59 + 1 OR
  R.ID <= TRUNC(LENGTH(P.VALUE_BEFORE) - 1) / 59 + 1 OR
  R.ID <= 1
ORDER BY
  P.BEGIN_TIME DESC,
  P.PARAMETER_NAME,
  R.ID
));
