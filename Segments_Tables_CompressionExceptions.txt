SELECT 
  /* Lists tables that are excluded from BRSPACE compression due to technical limitations,
     "-SCT" or _reorg_excl_tab (SAP Note 1431296) */
  NULL OWNER, NULL TABLE_NAME, NULL SIZE_MB, NULL EXCLUDED_VIA, NULL REASON FROM DUAL WHERE 1 = 0
UNION ALL (
SELECT NULL OWNER, NULL TABLE_NAME, NULL SIZE_MB, NULL EXCLUDED_VIA, NULL REASON FROM DUAL WHERE 1 = 0
) UNION ALL ( SELECT * FROM (
WITH BASIS_INFO AS
( SELECT
    '%' TABLE_NAME,
    100 MIN_SEGMENT_SIZE_MB,
    230 MIN_COLUMN_THRESHOLD,
    'SIZE' ORDER_BY       /* SIZE, NAME */
  FROM
    DUAL
),
SKIPPED_TABLES AS
( SELECT /*+ MATERIALIZE */
    OWNER,
    TABLE_NAME,
    EXCLUDED_VIA,
    REASON
  FROM
  ( SELECT
      DTC.OWNER,
      DTC.TABLE_NAME,
      'technical limit' EXCLUDED_VIA,
      DECODE(SIGN(COUNT(*) - 255), -1, 'close to 255 columns', '> 255 columns') REASON
    FROM
      BASIS_INFO BI,
      DBA_TAB_COLUMNS DTC
    WHERE
      DTC.TABLE_NAME LIKE BI.TABLE_NAME
    GROUP BY
      DTC.OWNER,
      DTC.TABLE_NAME,
      BI.MIN_COLUMN_THRESHOLD
    HAVING
      COUNT(*) > BI.MIN_COLUMN_THRESHOLD
    UNION 
    ( SELECT
        DTC.OWNER,
        DTC.TABLE_NAME,
        '-SCT' EXCLUDED_VIA,
        'INDX table' REASON
      FROM
        BASIS_INFO BI,
        DBA_TAB_COLUMNS DTC
      WHERE
        DTC.TABLE_NAME LIKE BI.TABLE_NAME AND
        DTC.COLUMN_NAME IN ('RELID', 'SRTF2', 'CLUSTR', 'CLUSTD')
      GROUP BY
        DTC.OWNER,
        DTC.TABLE_NAME
      HAVING
        COUNT(*) = 4
    )
    UNION
    ( SELECT
        T.OWNER,
        T.TABLE_NAME,
        '-SCT' EXCLUDED_VIA,
        'ABAP table' REASON
      FROM
        BASIS_INFO BI,
        DBA_TABLES T
      WHERE    
        T.TABLE_NAME LIKE BI.TABLE_NAME AND
        T.TABLE_NAME IN ('REPOSRC', 'REPOLOAD')
    )
    UNION
    ( SELECT
        T.OWNER,
        T.TABLE_NAME,
        '-SCT' EXCLUDED_VIA,
        'Update table' REASON
      FROM
        BASIS_INFO BI,
        DBA_TABLES T
      WHERE    
        T.TABLE_NAME LIKE BI.TABLE_NAME AND
        T.TABLE_NAME IN ('VBHDR', 'VBDATA', 'VBMOD', 'VBERROR')
    )
    UNION
    ( SELECT
        USER OWNER,
        DD.TABNAME,
        '-SCT' EXCLUDED_VIA,
        'POOL table' REASON
      FROM
        BASIS_INFO BI,
        DDNTT DD
      WHERE
        DD.TABNAME LIKE BI.TABLE_NAME AND
        DD.TABTYPE = 'P' AND 
        DD.TABFORM = 'T'
    )
    UNION
    ( SELECT
        USER OWNER,
        DD.TABNAME TABLE_NAME,
        '-SCT' EXCLUDED_VIA,
        'CLUSTER table' REASON
      FROM
        BASIS_INFO BI,
        DDNTT DD
      WHERE
        DD.TABNAME LIKE BI.TABLE_NAME AND
        DD.TABTYPE = 'C' AND 
        DD.TABFORM = 'T'
    )
    UNION
    ( SELECT
        T.OWNER,
        T.TABLE_NAME,
        '_reorg_excl_tab' EXCLUDED_VIA,
        'RFC table' REASON
      FROM
        BASIS_INFO BI,
        DBA_TABLES T
      WHERE    
        T.TABLE_NAME LIKE BI.TABLE_NAME AND
        T.TABLE_NAME IN ('ARFCSSTATE', 'ARFCSDATA', 'ARFCRSTATE', 'TRFCQDATA',
         'TRFCQIN', 'TRFCQOUT', 'TRFCQSTATE', 'QRFCTRACE', 'QRFCLOG')
    )
    UNION
    ( SELECT
        T.OWNER,
        T.TABLE_NAME,
        '_reorg_excl_tab' EXCLUDED_VIA,
        'Number range table' REASON
      FROM
        BASIS_INFO BI,
        DBA_TABLES T
      WHERE    
        T.TABLE_NAME LIKE BI.TABLE_NAME AND
        T.TABLE_NAME IN ('NRIV')
    )
  )
)
SELECT
  ST.OWNER,
  ST.TABLE_NAME,
  TO_CHAR(SUM(S.BYTES) / 1024 / 1024, 99999990.99) SIZE_MB,
  ST.EXCLUDED_VIA,
  ST.REASON
FROM
  BASIS_INFO BI,
  SKIPPED_TABLES ST,
  DBA_SEGMENTS S
WHERE
  ST.OWNER = S.OWNER AND
  ST.TABLE_NAME = S.SEGMENT_NAME AND
  S.BYTES / 1024 / 1024 >= BI.MIN_SEGMENT_SIZE_MB
GROUP BY
  ST.OWNER,
  ST.TABLE_NAME,
  ST.EXCLUDED_VIA,
  ST.REASON,
  BI.ORDER_BY
ORDER BY
  DECODE(BI.ORDER_BY, 'SIZE', SUM(S.BYTES), 1) DESC,
  DECODE(BI.ORDER_BY, 'NAME', ST.OWNER || ST.TABLE_NAME, ' ')
));
